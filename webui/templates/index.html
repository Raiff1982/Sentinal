<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sentinal Hoax/Misinformation Scanner</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 600px; margin: auto; }
        .result { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
        button { padding: 8px 16px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sentinal Hoax/Misinformation Scanner</h1>
        {% if user and session['role'] == 'admin' %}
        <div class="result" style="background:#ffe0e0; border:2px solid #d00; margin-bottom:20px;">
            <h2>Admin Panel</h2>
            <p>Welcome, Admin! You have access to advanced features.</p>
            <ul>
                <li><a href="/admin/dashboard">Admin Dashboard</a></li>
                <li><a href="/admin/users">Manage Users</a></li>
                <li><a href="/admin/logs">View Logs</a></li>
            </ul>
        </div>
        {% endif %}
        <form id="scanForm" enctype="multipart/form-data">
            <label for="text">Enter text to scan:</label><br>
            <textarea id="text" name="text" rows="6" cols="60"></textarea><br><br>
            <label for="file">Or upload a text file:</label><br>
            <input type="file" id="file" name="file" accept=".txt"><br><br>
            <label for="scanModel">Select Scan Model:</label>
            <select id="scanModel" name="scanModel">
                <option value="finetuned_llm">Fine-tuned LLM</option>
                <option value="distilbert-base-uncased">DistilBERT</option>
                <option value="roberta-base">RoBERTa</option>
            </select><br><br>
            <button type="submit">Scan</button>
        </form>
        <div id="result" class="result" style="display:none;"></div>
        <hr>
        <h2>Chat Interface</h2>
        <form id="chatForm">
            <input type="text" id="chatInput" name="chatInput" placeholder="Type your message..." style="width:80%;">
            <label for="chatModel">Select Chat Model:</label>
            <select id="chatModel" name="chatModel">
                <option value="codette_cocoon_model">Codette Cocoon</option>
                <option value="distilgpt2">DistilGPT2</option>
                <option value="gpt2">GPT2</option>
            </select>
            <button type="submit">Send</button>
        </form>
        <div id="chatHistory" class="result" style="margin-top:10px;"></div>
    </div>
    <script>
        document.getElementById('scanForm').onsubmit = async function(e) {
            e.preventDefault();
            const text = document.getElementById('text').value;
            const fileInput = document.getElementById('file');
            const formData = new FormData();
            formData.append('text', text);
            if (fileInput.files.length > 0) {
                formData.append('file', fileInput.files[0]);
            }
            formData.append('scanModel', document.getElementById('scanModel').value);
            const res = await fetch('/scan', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            document.getElementById('result').style.display = 'block';
            let aiHtml = '';
            if (data.ai_result && data.ai_result[0] && data.ai_result[0].details) {
                aiHtml = `<b>AI Ensemble:</b><ul>`;
                for (const detail of data.ai_result[0].details) {
                    aiHtml += `<li>${detail.label} (${detail.score.toFixed(2)})</li>`;
                }
                aiHtml += `</ul><b>Majority Label:</b> ${data.ai_result[0].label} (<b>Avg Score:</b> ${data.ai_result[0].score.toFixed(2)})<br>`;
            }
            let explanationHtml = '';
            if (data.explanation) {
                explanationHtml = `<b>Explanation:</b> ${data.explanation}<br>`;
            }
            document.getElementById('result').innerHTML =
                aiHtml +
                `<b>Red Flag Hits:</b> ${data.red_flag_hits}<br>` +
                `<b>Source Score:</b> ${data.source_score}<br>` +
                `<b>Verdict:</b> ${data.verdict}<br>` +
                explanationHtml;
            if (data.chat_history) {
                updateChatHistory(data.chat_history);
            }
        };

        document.getElementById('chatForm').onsubmit = async function(e) {
            e.preventDefault();
            const chatInput = document.getElementById('chatInput').value;
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'text=' + encodeURIComponent(chatInput) + '&chatModel=' + encodeURIComponent(document.getElementById('chatModel').value)
            });
            const data = await res.json();
            if (data.chat_history) {
                updateChatHistory(data.chat_history);
            }
            document.getElementById('chatInput').value = '';
        };

        function updateChatHistory(history) {
            let html = '';
            for (const entry of history) {
                let aiHtml = '';
                if (entry.ai && entry.ai[0] && entry.ai[0].details) {
                    aiHtml = `<b>AI Ensemble:</b><ul>`;
                    for (const detail of entry.ai[0].details) {
                        aiHtml += `<li>${detail.label} (${detail.score.toFixed(2)})</li>`;
                    }
                    aiHtml += `</ul><b>Majority Label:</b> ${entry.ai[0].label} (<b>Avg Score:</b> ${entry.ai[0].score.toFixed(2)})<br>`;
                }
                let llmHtml = '';
                if (entry.llm) {
                    if (Array.isArray(entry.llm)) {
                        llmHtml = `<b>LLM Responses:</b><ul>`;
                        for (const resp of entry.llm) {
                            llmHtml += `<li>${resp}</li>`;
                        }
                        llmHtml += `</ul>`;
                    } else {
                        llmHtml = `<b>LLM Response:</b> ${entry.llm}<br>`;
                    }
                }
                let explanationHtml = '';
                if (entry.explanation) {
                    explanationHtml = `<b>Explanation:</b> ${entry.explanation}<br>`;
                }
                html += `<div><b>You:</b> ${entry.user}<br>${aiHtml}${llmHtml}<b>Verdict:</b> ${entry.result}<br>${explanationHtml}</div><hr>`;
            }
            document.getElementById('chatHistory').innerHTML = html;
        }
    </script>
</body>
</html>
